---
import BaseLayout from '../layouts/BaseLayout.astro';
import MangaCard from '../components/MangaCard.astro';
import SearchBar from '../components/SearchBar.astro';

const API_URL = 'http://localhost:3000/api';

// Fetch initial manga list
async function getMangaList() {
  try {
    const response = await fetch(`${API_URL}/search?query=popular`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    
    // The API returns an object with a 'mangas' property
    if (data && data.mangas && Array.isArray(data.mangas)) {
      // Show all mangas or increase the limit
      return data.mangas; // Remove the slice to show all mangas
      // Or if you want to show more but not all:
      // return data.mangas.slice(0, 24); // Show 24 mangas
    } else {
      console.error('Unexpected API response structure:', data);
      return [];
    }
  } catch (error) {
    console.error('Error fetching manga:', error);
    return [];
  }
}

const mangaList = await getMangaList();
---

<BaseLayout>
  <div class="home-container">
    <SearchBar />
    <h1 class="page-title">Popular Manga</h1>
    {mangaList.length === 0 ? (
      <div class="error-message">
        <p>Unable to load manga. Please check if the backend server is running.</p>
      </div>
    ) : (
      <div class="manga-grid">
        {mangaList.map((manga: any) => <MangaCard manga={manga} />)}
      </div>
    )}
  </div>
</BaseLayout>

<style>
  .home-container {
    margin-top: 20px;
  }
  
  .page-title {
    margin: 30px 0 20px;
    color: var(--primary);
  }
  
  .manga-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
  }
  
  .error-message {
    text-align: center;
    padding: 20px;
    background-color: #f8d7da;
    color: #721c24;
    border-radius: 8px;
    margin: 20px 0;
  }
</style>